---
output:
  bookdown::pdf_document2:
    fig_caption: true
    includes: null
    toc: no
---
# Appendix C. Assessing uncertainty in model output due to lack of terminal year survey data for St. Matthew blue king crab (SMBKC) {-}

\pagenumbering{gobble}

```{r global_options, include=FALSE, echo = FALSE, message = FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(fig.width = 12, fig.height = 7, echo = FALSE, warning = FALSE, message = FALSE,  dpi=300)
```

# Introduction{-}
NMFS trawl surveys during the summer of 2020 were cancelled due to logistic difficulties caused by the global pandemic COVID-19. Therefore, the crab assessment authors meet to discuss approaches to address the potential of additional uncertainty in the current year models - specifically the projected mature male biomass and associated reference points. The objective of these approaches/simulations was to provide the plan team (CPT) and the SSC a range of potential additional uncertainty that could be applied to the buffers used on the OFL calculations to produce an appropriate ABC. 

## Objectives {-}

    1. Can we characterize the additional uncertainty in the current years estimates due to 
    the lack of terminal year survey data? If so, what does it look like?

    2. Is the model uncertainty characterized in objective #1 currently included in the ABC 
    buffer applied to this stock or do we need to apply additional uncertainty measures?


# Approaches {-}


## Approach 1 and 2: retrospective patterns with and without terminal survey data {-}

Retrospective analysis are typically performed on models to characterize the tendencies of a model to over or under estimate current trends in biomass, recruitment, etc. Retrospective patterns are described as a clear tendency for a model to either over or under estimate. Approach 1 compares the output of retrospective models with the terminal year of survey data and ones where the terminal year of trawl survey data are removed (both abundance and size composition data). 
A number of key model outputs were compared for these retrospective runs. These include: average recruitment, Bmsy, status of the stock, terminal year mmb, and reference point calculations (OFL). 

### Results {-}
In general models that lacked the terminal year of survey data performed similarly to models with the survey data. In cases where the model outputs differed the model without the terminal year of survey data tended to have results similar to the previous years model. 



## Approach 3: encompassing expected variability {-}

This approach was designed to run models with "fake" 2020 data to determine how much a data point in 2020 could have potential influenced the model outcome. The same key model outputs were compared in this approach as in approach 1. 

This approach evaluates the impact of different hypothetical 2020 survey outcomes, and is based on a SSC recommendation in its June minutes. Using the NMFS trawl survey time series fit in the proposed base or reference model the multiplicative residuals were calculated (predicted survey fit/observed survey data point) for each year. The 25th and 75th percentiles of the multiplicative residual distribution were obtained, which would represent a typical low and high value for the survey (Martin Dorn per comm.). 

A predicted survey value was obtained for 2020 by running the base model with a hypothetical survey value with a very high CV (100), so that the model did not attempt to fit the observation. For SMBKC the hypothetical survey value was an average of the last 4 years of the survey to best estimate the hypothetical 2020 data point even though the CV for this data point was large. Once the base model was fit with this hypothetical data point the resulting estimate for the 2020 survey was used to complete two additional model runs. These runs multiplied the predicted 2020 survey data point by the 25th and 75th percentiles of the multiplicative residuals to simulate a "low" and "high" survey data point. The CV for these runs was set equal to the median survey CV. These two runs were evaluated along side the 2020 base model to determine the sensitivity of model output and management quantities on the 2020 survey data point. 

### Results {-}
Overall, the model output and management quantities did not differ much between the base and the low and high hyppothetical survey data runs for 2020 (Figure \@ref(fig:app3-compare)). The estimate mature male biomass trend was the same, with little difference evident when viewing the entire time series (Figure \@ref(fig:app3-all-ssb)). A detailed view of the last 10 years is provided for the mmb estimates in order to view the small difference in the three model estimates. The trends are all similar, with the only difference being the scale of the mmb estimate in the last 7 years (Figure \@ref(fig:app3-compare2)). In reference to the base model the "high" run increased the mmb by a very small amount, where the "low" run decreased the mmb trend by about twice as much. All model estimates were very similar and within the typical range of uncertainty of the base model (add figure for this here). 

Add table for quantities, plus % difference between them.


\pagebreak 

# Figures {-}
\newpage

```{r retrospective, fig.cap = "Retrospective run estimates of mature male biomass (mmb) for the SMBKC reference model (16.0) for the last 10 years. "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/ssb_time_series_normal.png"), dpi = 125)
```


```{r retrospective2, fig.cap = "Retrospective run estimates of mature male biomass (mmb) for the SMBKC reference model (16.0) for the last 10 years, only showing the last 20 years for a detailed view. "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/ssb_time_series_normal_current.png"), dpi = 125)
```

```{r retrospective-compare, fig.cap = "Retrospective run estimates of mature male biomass (mmb) for the SMBKC reference model (16.0) including models that eliminated the terminal year survey data. "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/ssb_time_series_all.png"), dpi = 125)
```

```{r retrospective-compare2, fig.cap = "Retrospective run estimates of mature male biomass (mmb) for the SMBKC reference model (16.0) including models that eliminated the terminal year survey data for the last 5 model years. Highlighting the last 20 years for a more detailed view.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/ssb_time_series_last5_compare_recent.png"), dpi = 125)
```

```{r compare-avgR, fig.cap = "Comparison of average recruitment model estimates from 'normal' retrospective runs and those without the terminal year survey data.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/avgR_compare.png"), dpi = 125)
```

```{r compare-bmsy, fig.cap = "Comparison of Bmsy model estimates from 'normal' retrospective runs and those without the terminal year survey data.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/Bmsy_compare.png"), dpi = 125)
```

```{r compare-status, fig.cap = "Comparison of the model estimate of 'status' (B/Bmsy) from 'normal' retrospective runs and those without the terminal year survey data.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/Status_compare.png"), dpi = 125)
```

```{r compare-mmb, fig.cap = "Comparison of the model estimate of terminal year mmb from 'normal' retrospective runs and those without the terminal year survey data.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/Terminal_mmb_compare.png"), dpi = 125)
```


```{r compare-fofl, fig.cap = "Comparison of the model estimate of fofl from 'normal' retrospective runs and those without the terminal year survey data.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/fofl_compare.png"), dpi = 125)
```


```{r compare-OFL, fig.cap = "Comparison of the model estimate of OFL from 'normal' retrospective runs and those without the terminal year survey data.  "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/OFL_compare.png"), dpi = 125)
```


```{r app3-all-ssb, fig.cap = "Mature male biomass estimates from approach 3. Comparing the 2020 base model with a model that has a high 'fake' 2020 survey data point and one that has a low 'fake' survey data point. "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/app3_ssb_all_yrs.png"), dpi = 125)
```

```{r app3-all-ssb2, fig.cap = "Mature male biomass estimates from approach 3. Comparing the 2020 base model with a model that has a high 'fake' 2020 survey data point and one that has a low 'fake' survey data point, only showing the last 20 years for detail on model differentiation. "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/app3_last_10yrs_ssb.png"), dpi = 125)
```


```{r app3-compare, fig.cap = "Model output and reference points from approach 3. Comparing the 2020 base model with a model that has a high 'fake' 2020 survey data point and one that has a low 'fake' survey data point. "}
knitr::include_graphics(paste0(here::here(), "/SMBKC/smbkc_20/retrospective_model_1/figures/app3_bar_graph_output.png"), dpi = 125)
```